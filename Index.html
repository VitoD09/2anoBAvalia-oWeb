<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boss fight</title>
  <style>
    body {
      margin: 0;
      background: #111;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: white;
      flex-direction: column;
      font-family: 'Courier New', Courier, monospace;
    }
    canvas {
      display: block;
      background-image: url('https://files.catbox.moe/s1ywcn.png');
      background-size: cover;
      border: 8px groove #8B4513;
      max-width: 95%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <canvas id="jogo" width="500" height="300"></canvas>

  <script>
    const tela = document.getElementById("jogo");
    const ctx = tela.getContext("2d");
    ctx.imageSmoothingEnabled = false;

    const imagemCavaleiro = new Image();
    imagemCavaleiro.src = "https://files.catbox.moe/82ol9c.png";
    const imagemCavaleiroAtaque = new Image();
    imagemCavaleiroAtaque.src = "https://files.catbox.moe/fietvv.png";
    const imagemGoblin = new Image();
    imagemGoblin.src = "https://files.catbox.moe/axp8rl.png";
    const imagemGoblinAtaque = new Image();
    imagemGoblinAtaque.src = "https://files.catbox.moe/wy3kh2.png";

    let jogoAcabou = false;
    let mensagemFinal = "";

    let vidaCavaleiro = 100; 
    let quadro = 0;
    let direcao = 0; 
    let ultimoLado = 1; 
    let posicaoXCavaleiro = 100;
    let cavaleiroPulando = false;
    let velocidadeYCavaleiro = 5;
    let estaAtacando = false;
    let quadroAtaque = 0;
    let danoJaAplicado = false; 

    let estaDandoDash = false;
    let tempoDashRestante = 0;
    const duracaoDash = 50; 
    const velocidadeDash = 60; 
    let cooldownDash = 500; 
    let ultimoDash = 0;

    const escalaCavaleiro = 3;
    const larguraQuadro = 100;
    const alturaQuadro = 100;
    const corteX = 40;
    const corteY = 10;
    const larguraCorte = 20;
    const alturaCorte = 90;
    const novaLargura = larguraCorte * escalaCavaleiro;
    const novaAltura = alturaCorte * escalaCavaleiro;
    let posicaoYCavaleiro = tela.height - 145;
    const chaoYCavaleiro = posicaoYCavaleiro;
    const gravidadeCavaleiro = 0.9;
    const forcaPuloCavaleiro = -16;
    const totalQuadros = 6;
    const intervaloQuadros = 100;

    const totalQuadrosAtaque = 6;
    const intervaloAtaque = 100;
    const corteXAtk = 25;
    const corteYAtk = 10;
    const larguraCorteAtk = 50;
    const alturaCorteAtk = 90;
    const escalaAtaque = 3;
    const novaLarguraAtk = larguraCorteAtk * escalaAtaque;
    const novaAlturaAtk = alturaCorteAtk * escalaAtaque;

    let vidaGoblin = 200; 
    let goblinRecebendoDano = false; 
    let danoGoblinJaAplicado = false; 
    let quadroGoblin = 0;
    let direcaoGoblin = 1;
    let posicaoXGoblin = 300;
    let goblinAtacando = false;
    let quadroAtaqueGoblin = 0;

    const totalQuadrosGoblin = 4;
    const intervaloQuadrosGoblin = 150;
    const larguraQuadroGoblin = 100;
    const alturaQuadroGoblin = 100;
    const corteXGoblin = 35;
    const corteYGoblin = 30;
    const larguraCorteGoblin = 30;
    const alturaCorteGoblin = 40;
    const escalaGoblin = 5;
    const larguraGoblin = larguraCorteGoblin * escalaGoblin;
    const alturaGoblin = alturaCorteGoblin * escalaGoblin;
    const posicaoYGoblin = tela.height - 136;

    const intervaloAtaqueGoblin = 240; 
    const totalQuadrosAtaqueGoblin = 6;
    const larguraQuadroAtkGoblin = 100;
    const corteXAtkGoblin = 40;
    const corteYAtkGoblin = 20;
    const larguraCorteAtkGoblin = 30;
    const alturaCorteAtkGoblin = 40;
    const posicaoYAtaqueGoblin = tela.height - 180;

    let ultimoTempo = 0;
    let ultimoTempoAtaque = 0;
    let ultimoTempoGoblin = 0;
    let ultimoTempoAtaqueGoblin = 0;
    let imagensCarregadas = 0;
    const totalImagens = 4;

    document.addEventListener("keydown", (evento) => {
      if (jogoAcabou) return;
      if (evento.key === "w" && !cavaleiroPulando) {
        velocidadeYCavaleiro = forcaPuloCavaleiro;
        cavaleiroPulando = true;
      }

      if (evento.key === "d") { direcao = 1; ultimoLado = 1; }
      if (evento.key === "a") { direcao = -1; ultimoLado = -1; }
      if (evento.key === "Enter" && !estaAtacando) {
        estaAtacando = true;
        quadroAtaque = 0;
        ultimoTempoAtaque = 0;
        danoJaAplicado = false;
      }
      if (evento.key === "q" && !estaDandoDash) {
        const agora = performance.now();
        if (agora - ultimoDash >= cooldownDash) {
          estaDandoDash = true;
          tempoDashRestante = duracaoDash;
          ultimoDash = agora;
        }
      }
    });

    document.addEventListener("keyup", (evento) => {
      if ((evento.key === "d" && direcao === 1) || (evento.key === "a" && direcao === -1)) {
        direcao = 0;
      }
    });

    imagemCavaleiro.onload = imagemCavaleiroAtaque.onload = imagemGoblin.onload = imagemGoblinAtaque.onload = () => {
      imagensCarregadas++;
      if (imagensCarregadas === totalImagens) {
        requestAnimationFrame(animar);
      }
    };

    function desenharBarrasDeVida() {
        ctx.fillStyle = 'black';
        ctx.fillRect(10, 8, 104, 14);
        ctx.fillStyle = 'red';
        ctx.fillRect(12, 10, 100, 10);
        ctx.fillStyle = 'lime';
        ctx.fillRect(12, 10, Math.max(0, vidaCavaleiro), 10);
        ctx.strokeStyle = 'white';
        ctx.strokeRect(10, 8, 104, 14);
        ctx.fillStyle = 'white';
        ctx.fillText('Cavaleiro', 14, 32);

        const larguraBarraGoblin = 150;
        ctx.fillStyle = 'black';
        ctx.fillRect(tela.width - larguraBarraGoblin - 10, 8, larguraBarraGoblin + 4, 14);
        ctx.fillStyle = 'red';
        ctx.fillRect(tela.width - larguraBarraGoblin - 8, 10, larguraBarraGoblin, 10);
        ctx.fillStyle = 'darkgreen';
        const vidaAtualGoblin = (vidaGoblin / 200) * larguraBarraGoblin;
        ctx.fillRect(tela.width - larguraBarraGoblin - 8, 10, Math.max(0, vidaAtualGoblin), 10);
        ctx.strokeStyle = 'white';
        ctx.strokeRect(tela.width - larguraBarraGoblin - 10, 8, larguraBarraGoblin + 4, 14);
        ctx.fillStyle = 'white';
        ctx.fillText('Goblin Chefe', tela.width - 85, 32);
    }
    
    function desenharTelaFinal() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(0, 0, tela.width, tela.height);
        ctx.fillStyle = "white";
        ctx.font = "40px 'Arial'";
        ctx.textAlign = "center";
        ctx.fillText(mensagemFinal, tela.width / 2, tela.height / 2);
    }

    function animar(tempo) {
      if (jogoAcabou) {
          desenharTelaFinal();
          return;
      }
      ctx.clearRect(0, 0, tela.width, tela.height);
      velocidadeYCavaleiro += gravidadeCavaleiro;
      posicaoYCavaleiro += velocidadeYCavaleiro;
      if (cavaleiroPulando) {
          posicaoXCavaleiro += direcao * 1.5;
      }
      if (posicaoYCavaleiro >= chaoYCavaleiro) {
          posicaoYCavaleiro = chaoYCavaleiro;
          cavaleiroPulando = false;
          velocidadeYCavaleiro = 0;
      }
      if (estaDandoDash) {
        const direcaoDash = ultimoLado; 
        posicaoXCavaleiro += direcaoDash * velocidadeDash;
        posicaoXCavaleiro = Math.max(0, Math.min(tela.width - novaLargura, posicaoXCavaleiro));

        tempoDashRestante -= tempo - ultimoTempo;
        if (tempoDashRestante <= 0) {
          estaDandoDash = false;
        }
      }
      if (vidaGoblin > 0) {
        let imagemAtual, quadroAtual, larguraQuadro, cX, cY, cW, cH;
        let direcaoFinal;

        let alcanceAtaqueDireita = 140;
        let alcanceAtaqueEsquerda = 40;
        let estaNaDireita = posicaoXCavaleiro > posicaoXGoblin;
        let goblinAtacando = !cavaleiroPulando && (
            (estaNaDireita && (posicaoXCavaleiro - posicaoXGoblin) <= alcanceAtaqueDireita) ||
            (!estaNaDireita && (posicaoXGoblin - posicaoXCavaleiro) <= alcanceAtaqueEsquerda)
        );
        if (goblinAtacando) {
          if (tempo - ultimoTempoAtaqueGoblin > intervaloAtaqueGoblin) {
            quadroAtaqueGoblin = (quadroAtaqueGoblin + 1) % totalQuadrosAtaqueGoblin;
            ultimoTempoAtaqueGoblin = tempo;

            if (quadroAtaqueGoblin === 0) {
                danoGoblinJaAplicado = false;
            }
          }
          direcaoFinal = (posicaoXCavaleiro > posicaoXGoblin) ? 1 : -1;
          imagemAtual = imagemGoblinAtaque;
          quadroAtual = quadroAtaqueGoblin;
          larguraQuadro = larguraQuadroAtkGoblin;
          cX = corteXAtkGoblin; cY = corteYAtkGoblin; cW = larguraCorteAtkGoblin; cH = alturaCorteAtkGoblin;
        } else {
          quadroAtaqueGoblin = 0; 
          if (tempo - ultimoTempoGoblin > intervaloQuadrosGoblin) {
            quadroGoblin = (quadroGoblin + 1) % totalQuadrosGoblin;
            ultimoTempoGoblin = tempo;
          }
          posicaoXGoblin += direcaoGoblin * 0.5;
          if (posicaoXGoblin <= 0 || posicaoXGoblin >= tela.width - larguraGoblin) {
            direcaoGoblin *= -1;
          }
          direcaoFinal = direcaoGoblin;
          imagemAtual = imagemGoblin;
          quadroAtual = quadroGoblin;
          larguraQuadro = larguraQuadroGoblin;
          cX = corteXGoblin; cY = corteYGoblin; cW = larguraCorteGoblin; cH = alturaCorteGoblin;
        }
        const posicaoYFinalGoblin = goblinAtacando ? posicaoYAtaqueGoblin : posicaoYGoblin;
        ctx.save();

        if(goblinRecebendoDano) {
            ctx.globalAlpha = 1;
        }
        if (direcaoFinal === -1) {
          ctx.translate(posicaoXGoblin + larguraGoblin, posicaoYFinalGoblin);
          ctx.scale(-1, 1);
          ctx.drawImage(imagemAtual, quadroAtual * larguraQuadro + cX, cY, cW, cH, 0, 0, larguraGoblin, alturaGoblin);
        } else {
          ctx.drawImage(imagemAtual, quadroAtual * larguraQuadro + cX, cY, cW, cH, posicaoXGoblin, posicaoYFinalGoblin, larguraGoblin, alturaGoblin);
        }
        ctx.restore();

      } else { 
        ctx.drawImage(imagemGoblin, 0, 0, larguraCorteGoblin, alturaCorteGoblin, posicaoXGoblin, posicaoYGoblin, larguraGoblin, alturaGoblin);
        jogoAcabou = true;
        mensagemFinal = "VocÃª Venceu!";
      }
      let spriteAtual, quadroAtualCavaleiro, cxCavaleiro, cyCavaleiro, cwCavaleiro, chCavaleiro, nw, nh;
      if (estaAtacando) {
        if (tempo - ultimoTempoAtaque > intervaloAtaque) {
          quadroAtaque++;
          ultimoTempoAtaque = tempo;
        }
        if (quadroAtaque >= totalQuadrosAtaque) estaAtacando = false;
        spriteAtual = imagemCavaleiroAtaque; quadroAtualCavaleiro = quadroAtaque;
        cxCavaleiro = corteXAtk; cyCavaleiro = corteYAtk; cwCavaleiro = larguraCorteAtk; chCavaleiro = alturaCorteAtk;
        nw = novaLarguraAtk; nh = novaAlturaAtk;
      } else {
        if (direcao !== 0) {
          if (tempo - ultimoTempo > intervaloQuadros) {
            quadro = (quadro + 1) % totalQuadros;
            ultimoTempo = tempo;
          }
          posicaoXCavaleiro += direcao * 1.5;
          posicaoXCavaleiro = Math.max(0, Math.min(tela.width - novaLargura, posicaoXCavaleiro));
        } else {
          quadro = 0;
        }
        spriteAtual = imagemCavaleiro; quadroAtualCavaleiro = quadro;
        cxCavaleiro = corteX; cyCavaleiro = corteY; cwCavaleiro = larguraCorte; chCavaleiro = alturaCorte;
        nw = novaLargura; nh = novaAltura;
      }

      ctx.save();
      let desenharX;
      if (estaAtacando) {
        desenharX = posicaoXCavaleiro - (novaLarguraAtk - novaLargura) / 2;
      } else {
        desenharX = posicaoXCavaleiro;
      }

      if (ultimoLado === -1) {
        ctx.translate(desenharX + nw, posicaoYCavaleiro);
        ctx.scale(-1, 1);
        ctx.drawImage(spriteAtual, quadroAtualCavaleiro * larguraQuadro + cxCavaleiro, cyCavaleiro, cwCavaleiro, chCavaleiro, 0, 0, nw, nh);
      } else {
        ctx.drawImage(spriteAtual, quadroAtualCavaleiro * larguraQuadro + cxCavaleiro, cyCavaleiro, cwCavaleiro, chCavaleiro, desenharX, posicaoYCavaleiro, nw, nh);
      }
      ctx.restore();

      if (estaAtacando && !danoJaAplicado && vidaGoblin > 0) {
        const caixaAtaque = {
          x: ultimoLado === 1 ? posicaoXCavaleiro : posicaoXCavaleiro - (novaLarguraAtk - novaLargura),
          y: posicaoYCavaleiro, largura: novaLarguraAtk, altura: novaAlturaAtk
        };
        const caixaGoblin = { x: posicaoXGoblin + 100, y: posicaoYGoblin + 30, largura: larguraGoblin - 30, altura: alturaGoblin - 50};
        if (caixaAtaque.x < caixaGoblin.x + caixaGoblin.largura &&
            caixaAtaque.x + caixaAtaque.largura > caixaGoblin.x &&
            caixaAtaque.y < caixaGoblin.y + caixaGoblin.altura &&
            caixaAtaque.altura + caixaAtaque.y > caixaGoblin.y) {
          vidaGoblin -= 10; 
          danoJaAplicado = true;
          if (!goblinRecebendoDano) {
              goblinRecebendoDano = true;
              setTimeout(() => { goblinRecebendoDano = false; }, 200);
          }
        }
      }
      if(goblinAtacando && !danoGoblinJaAplicado && quadroAtaqueGoblin >= 4) { 
          const direcaoGoblinFinal = (posicaoXCavaleiro > posicaoXGoblin) ? 1 : -1;
          const caixaAtaqueGoblin = {
              x: direcaoGoblinFinal === 1 ? posicaoXGoblin + larguraGoblin/2 : posicaoXGoblin - larguraGoblin,
              y: posicaoYAtaqueGoblin,
              largura: larguraGoblin * 1.5,
              altura: alturaGoblin
          };
          const caixaCavaleiro = {x: posicaoXCavaleiro, y: posicaoYCavaleiro, largura: novaLargura, altura: novaAltura};

          if (caixaAtaqueGoblin.x < caixaCavaleiro.x + caixaCavaleiro.largura &&
              caixaAtaqueGoblin.x + caixaAtaqueGoblin.largura > caixaCavaleiro.x &&
              caixaAtaqueGoblin.y < caixaCavaleiro.y + caixaCavaleiro.altura &&
              caixaAtaqueGoblin.altura + caixaAtaqueGoblin.y > caixaCavaleiro.y) {
                vidaCavaleiro -= 15;
                danoGoblinJaAplicado = true;
                if(vidaCavaleiro <= 0) {
                    jogoAcabou = true;
                    mensagemFinal = "Game Over";
                }
            }
      }
      desenharBarrasDeVida();
      requestAnimationFrame(animar);
    }
  </script>
</body>
</html>
